<!DOCTYPE html>
<html>
<head>
<title>README.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="harmonic-cableos-vcmts-image-documentation">Harmonic CableOS VCMTS Image Documentation</h1>
<ul>
<li><a href="#harmonic-cableos-vcmts-image-documentation">Harmonic CableOS VCMTS Image Documentation</a>
<ul>
<li><a href="#customize-the-vendor-provided-debian-in-ram-filesystem-iso">Customize the vendor-provided Debian In-Ram-Filesystem .iso</a>
<ul>
<li><a href="#variables-and-defaults-required-package-installation">Variables and Defaults, Required package installation.</a></li>
<li><a href="#step-1-extract-the-iso-file">Step 1: Extract the ISO file</a></li>
<li><a href="#step-2-extract-debirf-livecgz">Step 2: Extract debirf-live.cgz</a></li>
<li><a href="#step-3-extract-rootscxz">Step 3: Extract roots.cxz</a></li>
<li><a href="#step-4-add-custom-files">Step 4: Add custom files</a></li>
<li><a href="#step-5-repack-the-root-filesystem">Step 5: Repack the root filesystem</a></li>
<li><a href="#step-6-repack-debirf-livecgz">Step 6: Repack debirf-live.cgz</a></li>
<li><a href="#step-7-recreate-the-iso">Step 7: Recreate the ISO</a></li>
</ul>
</li>
<li><a href="#complete-auto-build-script">Complete Auto-Build Script</a></li>
<li><a href="#packer-conversion-hcl2">Packer Conversion HCL2</a></li>
</ul>
</li>
</ul>
<h2 id="customize-the-vendor-provided-debian-in-ram-filesystem-iso">Customize the vendor-provided Debian In-Ram-Filesystem .iso</h2>
<h3 id="variables-and-defaults-required-package-installation">Variables and Defaults, Required package installation.</h3>
<pre class="hljs"><code><div>requiredPkgs=( "genisoimage" "mkisofs" "makefs" "mkinitramfs" "livecd-rootfs" "fakeroot" "live-build" )
: "${USERDATA:=/opt/userdata}"
: "${APOLLO_ISO:=APOLLO_PLATFORM-release-3.21.3.0-7+auto15.iso}"
: "${INSTALL_SCRIPT:=cableos-installer.sh}"
: "${ELTORITO:=stage2_eltorito}"
: "${LIVEIMG_URL:=https://gemmei.ftp.acc.umu.se/debian-cd/current/amd64/iso-cd/debian-12.5.0-amd64-netinst.iso}"
: "${LIVEIMG_ISO:=$(basename $LIVEIMG_URL)}"
: "${DEBIRF_ISO:=debirf-live_bullseye_6.0.0-0.deb11.6-amd64.iso}"
: "${WORKDIR:=${HOME}/cableos-live}"
: "${LIVEFS_DIR:=${WORKDIR}/${DEBIRF_ISO%.*}}"
: "${ROOTFS_DIR:=${LIVEFS_DIR}/rootfs}"

sudo apt-get -y install "${!requiredPkgs[@]}"
</div></code></pre>
<h3 id="step-1-extract-the-iso-file">Step 1: Extract the ISO file</h3>
<ul>
<li>Create a working directory.</li>
<li>Unpack debirf minimal.tgz into working directory</li>
<li>Mount the .iso file at /mnt .</li>
<li>Copy the contents at /mnt/* to the newly created working directory.</li>
<li>Unmount the .iso from /mnt .</li>
<li>Change directories to the newly created working directory</li>
</ul>
<pre class="hljs"><code><div>mkdir "${WORKDIR}"
tar -xzvf "${DEBIRF_MINIMAL}" -C "${WORKDIR}"
sudo mount -o loop "${USERDATA}/${DEBIRF_ISO}" /mnt
cp -r /mnt/* "${WORKDIR}/"
sudo umount /mnt
cd "${WORKDIR}"

</div></code></pre>
<h3 id="step-2-extract-debirf-livecgz">Step 2: Extract debirf-live.cgz</h3>
<ul>
<li>Create the target folder for the live filesystem.</li>
<li>Change directories to the previously created livefs directory.</li>
<li>Extract the filesystem archive using zcat to read the contents of the .cgz file and pipe the output to cpio to extract them.</li>
<li>Remove the .cgz file</li>
</ul>
<pre class="hljs"><code><div>(mkdir "${LIVEFS_DIR}" &amp;&amp; cd "${LIVEFS_DIR}" &amp;&amp; zcat "${WORKDIR}/${DEBIRF_ISO%.*}.cgz" | cpio -idvm &amp;&amp; rm -f "${WORKDIR}/${DEBIRF_ISO%.*}.cgz")
</div></code></pre>
<h3 id="step-3-extract-rootscxz">Step 3: Extract roots.cxz</h3>
<ul>
<li>Create a target folder for rootfs.</li>
<li>Change directories to the previously created rootfs folder.</li>
<li>Extract the rootfs using xzcat to read the contents of the .cxz file and pipe the output to cpio to extract them.</li>
<li>Remove the .cxz file</li>
</ul>
<pre class="hljs"><code><div>(mkdir "${ROOTFS_DIR}" &amp;&amp; cd "${ROOTFS_DIR}/" &amp;&amp; xzcat "${LIVEFS_DIR}/rootfs.cxz" | cpio -idvm &amp;&amp; rm -f "${LIVEFS_DIR}/rootfs.cxz")
</div></code></pre>
<h3 id="step-4-add-custom-files">Step 4: Add custom files</h3>
<p>Here we are delaring an array of of files that will be copied into the rootfs directory with the following structure:</p>
<p><code>key</code>: /path/to/source/file.ext</p>
<p><code>value</code>: /path/to/rootfs/destination/dir/</p>
<p>The script below performs the following checks and actions.</p>
<p>For each file in the array :</p>
<ul>
<li>
<p>Check that the destination directory is not present</p>
<p><strong><code>AND</code></strong></p>
<ul>
<li>Create the destination directory</li>
</ul>
</li>
<li>
<p>Check that the source file exists</p>
<p><strong><code>AND</code></strong></p>
</li>
<li>
<p>(The destination file does not ) <strong><code>OR</code></strong> (The source and destination files are not identical)</p>
<p><strong><code>AND</code></strong></p>
<ul>
<li>Copy the source file to the destination directory</li>
</ul>
</li>
</ul>
<pre class="hljs"><code><div>declare -A filePaths
FILE1="${USERDATA}/${APOLLO_ISO}"
FILE2="${USERDATA}/${INSTALL_SCRIPT}"
filePaths["${FILE1}"]="${ROOTFS_DIR}/data"
filePaths["${FILE2}"]="${ROOTFS_DIR}/root"

for fileName in "${!filePaths[@]}"; do

    [[ ! -d "${filePaths[${fileName}]}" ]] \
    &amp;&amp; echo -e "
    ${filePaths[${fileName}]} does not exist.
    mkdir -p ${filePaths[${fileName}]}
    " \
    &amp;&amp; mkdir -p "${filePaths[${fileName}]}"

    [[ -e ${fileName} ]] &amp;&amp; ([[ ! -e "${filePaths[${fileName}]}/$(basename ${fileName})" ]] || ! ( diff -q "${fileName}" "${filePaths[${fileName}]}/$(basename ${fileName})" )) \
    &amp;&amp; echo -e "
    cp ${fileName} ${filePaths[${fileName}]}/ \
    " \
    &amp;&amp; cp "${fileName}" "${filePaths[${fileName}]}/"
done
</div></code></pre>
<h3 id="step-5-repack-the-root-filesystem">Step 5: Repack the root filesystem</h3>
<ul>
<li>Recreate the .cpio archive.</li>
<li>Compress it back to .cxz archive</li>
</ul>
<pre class="hljs"><code><div>( cd "${ROOTFS_DIR}" &amp;&amp; find . | cpio -o -H newc | xz -z -T0 &gt; "${LIVEFS_DIR}/rootfs.cxz" &amp;&amp; rm -rf "${ROOTFS_DIR}" )
</div></code></pre>
<h3 id="step-6-repack-debirf-livecgz">Step 6: Repack debirf-live.cgz</h3>
<ul>
<li>Recreate the .cpio archive.</li>
<li>Compress it back to .cgz archive.</li>
</ul>
<pre class="hljs"><code><div>( cd "${LIVEFS_DIR}" &amp;&amp; find . | cpio -o -H newc | gzip -6 &gt; "${WORKDIR}/${DEBIRF_ISO%.*}.cgz" &amp;&amp; rm -rf "${LIVEFS_DIR}" )
</div></code></pre>
<h3 id="step-7-recreate-the-iso">Step 7: Recreate the ISO</h3>
<ul>
<li>Rebuild the .iso image from the updated working directory contents</li>
<li>If successful, print image and md5sum</li>
<li>If unsuccessful, print error notice and remove failed image</li>
</ul>
<pre class="hljs"><code><div>nsuccessful, print error notice and remove failed image

( mkisofs -R -b boot/grub/bios.img -no-emul-boot -boot-load-size 4 -boot-info-table -c boot/grub/boot.cat -input-charset utf-8 -o "${USERDATA}/REPACK-${DEBIRF_ISO}" . ) \
&amp;&amp; ( echo -e "
ISO Repack Completed Successfully.
New Image: ${USERDATA}/REPACK-${DEBIRF_ISO}
" \
&amp;&amp; md5sum ${USERDATA}/REPACK-${DEBIRF_ISO} | tee -a ${USERDATA}/REPACK-${DEBIRF_ISO}.md5sum ) \
|| ( echo -e "
ISO Repack Failed... Removing..
" &amp;&amp; rm -f ${USERDATA}/REPACK-${DEBIRF_ISO} )
</div></code></pre>
<h2 id="complete-auto-build-script">Complete Auto-Build Script</h2>
<p><strong><a href="cableos-debirf-rebuild.sh">CableOS Auto-Build Script</a></strong></p>
<p>The complete script will perform all of the steps listed above to:</p>
<ul>
<li>Create the directory structures</li>
<li>Mount the original .iso,</li>
<li>Copy the files into the proper locations and extrack theew                                                                                                                        op</li>
<li>Extract them to the proper locations</li>
<li>Add custom ISO and install script</li>
<li>Repack the archives</li>
<li>Recreate the ISO</li>
</ul>
<h2 id="packer-conversion-hcl2">Packer Conversion HCL2</h2>
<pre class="hljs"><code><div>// packer.pkr.hcl
  packer {
    required_plugins {
      qemu = {
        version = "&gt;= 0.0.1"
        source  = "github.com/hashicorp/qemu"
} }
  }
  source "qemu" "debirf-live" {
Feedback
Help Settings
1
"type": "file",
"source": "/initrd.img",
"destination": "output-debirf-live/initrd.img"
"type": "shell-local",
"inline": [
  "qemu-img convert -f qcow2 -O raw new.qcow new.img",
  "maas admin boot-resources create name=custom/new name_title='New Image' architecture=amd64/generic content@=new.img"
make build
iso_url = var.iso_url
iso_checksum = "none"
disk_size = "4096"
output_directory = var.output_directory
vm_name
format
accelerator http_directory = "http" boot_command =[

= var.iso_checksum
= 10240
= var.vm_name
= "qcow2"
= "kvm"
"&lt;enter&gt;&lt;wait&gt;",
"linux /install/vmlinuz auto hostname=${var.vm_name} &lt;wait&gt;",
"initrd /install/initrd.gz &lt;wait&gt;",
"boot&lt;enter&gt;"
]
ssh_username
ssh_password
ssh_port
ssh_wait_timeout = "10000s"
headless        = false
= var.ssh_username
= var.ssh_password
= 22
build {
  sources = [
    "source.qemu.debirf-live"
  ]
  provisioner "shell" {
    inline = [
      "sudo ostree-production install --source=Apollo.iso --destination=/",
      "sudo cp /boot/vmlinuz* /vmlinuz",
      "sudo cp /boot/initrd.img* /initrd.img"
    ]
  }
  provisioner "file" {
    source      = "/vmlinuz"
    destination = "${var.output_directory}/vmlinuz"
}
  provisioner "file" {
    source      = "/initrd.img"
    destination = "${var.output_directory}/initrd.img"
  }
  post-processor "qemu" {
    only
    output
    format
    disk_interface = "virtio"
    = ["qemu"]
    = var.new_qcow
    = "qcow2"
  }
  post-processor "shell-local" {
    inline = [
      "qemu-img convert -f qcow2 -O raw ${var.new_qcow} ${var.new_img}",
      "maas admin boot-resources create name=custom/new name_title='New Image' architecture=amd64/generic content@=${var.new_img}"
    ]
  }
}
</div></code></pre>

</body>
</html>
